# ============================================================
# Cooly AI - Production Deployment (Dokploy/VM)
# ============================================================
# This compose file is optimized for deployment on Dokploy
# with Traefik reverse proxy for SSL/domain management
# Environment variables are injected by Dokploy
# ============================================================

services:
  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    container_name: cooly-postgres-prod
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-cooly}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB:-cooly_prod}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./database/migrations:/docker-entrypoint-initdb.d/migrations:ro
      - ./script/docker-init-db.sh:/docker-entrypoint-initdb.d/00-init.sh:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-cooly} -d ${POSTGRES_DB:-cooly_prod}"]
      interval: 10s
      timeout: 5s
      retries: 10
    networks:
      - cooly-network
    restart: unless-stopped

  # Redis (for BullMQ queue)
  redis:
    image: redis:7-alpine
    container_name: cooly-redis-prod
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "--pass", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - cooly-network
    restart: unless-stopped

  # MinIO S3-compatible storage
  minio:
    image: minio/minio:latest
    container_name: cooly-minio-prod
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
    volumes:
      - minio_data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 15s
      timeout: 10s
      retries: 5
    networks:
      - cooly-network
      - dokploy-network
    restart: unless-stopped
    labels:
      # Traefik routing for MinIO API (internal only, no external access needed)
      - "traefik.enable=true"
      - "traefik.docker.network=dokploy-network"
      - "traefik.http.routers.minio-api.rule=Host(`${MINIO_DOMAIN:-minio.${DOMAIN}}`)"
      - "traefik.http.routers.minio-api.entrypoints=websecure"
      - "traefik.http.routers.minio-api.tls.certresolver=letsencrypt"
      - "traefik.http.routers.minio-api.service=minio-api"
      - "traefik.http.services.minio-api.loadbalancer.server.port=9000"
      # Traefik routing for MinIO Console (admin access)
      - "traefik.http.routers.minio-console.rule=Host(`${MINIO_CONSOLE_DOMAIN:-minio-console.${DOMAIN}}`)"
      - "traefik.http.routers.minio-console.entrypoints=websecure"
      - "traefik.http.routers.minio-console.tls.certresolver=letsencrypt"
      - "traefik.http.routers.minio-console.service=minio-console"
      - "traefik.http.services.minio-console.loadbalancer.server.port=9001"

  # MinIO bucket initialization
  minio-init:
    image: minio/mc:latest
    container_name: cooly-minio-init-prod
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      mc alias set local http://minio:9000 ${MINIO_ROOT_USER} ${MINIO_ROOT_PASSWORD};
      mc mb local/${S3_BUCKET_NAME} --ignore-existing;
      mc anonymous set download local/${S3_BUCKET_NAME};
      echo 'MinIO bucket initialized!';
      exit 0;
      "
    networks:
      - cooly-network

  # Backend API + Worker
  backend:
    build:
      context: .
      dockerfile: backend/Dockerfile
      args:
        NODE_ENV: production
    container_name: cooly-backend-prod
    environment:
      # Server
      NODE_ENV: production
      PORT: 5000
      LOG_LEVEL: ${LOG_LEVEL:-info}

      # Database
      DATABASE_URL: postgresql://${POSTGRES_USER:-cooly}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-cooly_prod}

      # Queue (BullMQ with Redis)
      REDIS_URL: redis://:${REDIS_PASSWORD}@redis:6379
      USE_BULLMQ: "true"
      START_GEN_WORKER: "true"
      START_OUTBOX_RELAY: "true"
      GEN_WORKER_CONCURRENCY: ${GEN_WORKER_CONCURRENCY:-5}
      ENABLE_CAPTURE_WORKER: "true"
      ENABLE_SESSION_SWEEPER: "true"

      # Storage (MinIO)
      S3_ENDPOINT: http://minio:9000
      S3_PUBLIC_URL: https://${MINIO_DOMAIN:-minio.${DOMAIN}}
      S3_FORCE_PATH_STYLE: "true"
      B2_BUCKET_NAME: ${S3_BUCKET_NAME}
      B2_REGION: us-east-1
      B2_ACCESS_KEY_ID: ${MINIO_ROOT_USER}
      B2_SECRET_ACCESS_KEY: ${MINIO_ROOT_PASSWORD}

      # Frontend URL for CORS
      FRONTEND_URL: https://${DOMAIN}
      ALLOWED_ORIGINS: https://${DOMAIN},https://www.${DOMAIN}
      COOKIE_DOMAIN: ${DOMAIN}

      # JWT & Security
      JWT_SECRET: ${JWT_SECRET}
      ADMIN_SECRET_KEY: ${ADMIN_SECRET_KEY}
      EXCHANGE_JWT_SECRET: ${EXCHANGE_JWT_SECRET}

      # API Provider Keys (injected by Dokploy)
      BYTEPLUS_APP_ID: ${BYTEPLUS_APP_ID}
      BYTEPLUS_ACCESS_TOKEN: ${BYTEPLUS_ACCESS_TOKEN}
      BYTEPLUS_SECRET_KEY: ${BYTEPLUS_SECRET_KEY}
      BYTEPLUS_ARK_API_KEY: ${BYTEPLUS_ARK_API_KEY}
      SEEDREAM4_API_KEY: ${SEEDREAM4_API_KEY}
      SEEDREAM4_MODEL_ID: ${SEEDREAM4_MODEL_ID:-seedream-4-0-250828}
      SEEDREAM4_API_BASE: ${SEEDREAM4_API_BASE:-https://ark.ap-southeast.bytepluses.com}
      SEEDANCE_API_BASE: ${SEEDANCE_API_BASE:-https://ark.ap-southeast.bytepluses.com}
      SEEDANCE_API_KEY: ${SEEDANCE_API_KEY}
      SEEDANCE_ENDPOINT_ID: ${SEEDANCE_ENDPOINT_ID}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      OPENAI_API_BASE: ${OPENAI_API_BASE:-https://api.openai.com/v1}
      SORA_PROVIDER: ${SORA_PROVIDER:-wavespeed}
      FAL_KEY: ${FAL_KEY}
      WAVESPEED_API_KEY: ${WAVESPEED_API_KEY}
      GOOGLE_PROJECT_ID: ${GOOGLE_PROJECT_ID}
      GOOGLE_CLOUD_PROJECT: ${GOOGLE_CLOUD_PROJECT}
      GOOGLE_LOCATION: ${GOOGLE_LOCATION:-us-central1}
      KIE_API_KEY: ${KIE_API_KEY}
      KIE_API_BASE: ${KIE_API_BASE:-https://api.kie.ai}

      # Stripe Billing
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY}
      STRIPE_PUBLISHABLE_KEY: ${STRIPE_PUBLISHABLE_KEY}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET}
      DEFAULT_FREE_CREDITS: ${DEFAULT_FREE_CREDITS:-10}

      # Google OAuth
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET}
      GOOGLE_REDIRECT_URI: https://${API_DOMAIN:-api.${DOMAIN}}/api/auth/google/callback

      # Email (SMTP)
      SMTP_HOST: ${SMTP_HOST}
      SMTP_PORT: ${SMTP_PORT:-465}
      SMTP_SECURE: ${SMTP_SECURE:-true}
      SMTP_USER: ${SMTP_USER}
      SMTP_PASS: ${SMTP_PASS}
      EMAIL_FROM: ${EMAIL_FROM}

      # Analytics
      POSTHOG_KEY: ${POSTHOG_KEY}
      POSTHOG_HOST: ${POSTHOG_HOST:-https://app.posthog.com}
      POSTHOG_IP_SALT: ${POSTHOG_IP_SALT}

      # Mock Modes (should be false for production)
      MOCK_API: ${MOCK_API:-false}
      MOCK_VIDEO: ${MOCK_VIDEO:-false}
      MOCK_SEEDREAM4: ${MOCK_SEEDREAM4:-false}
      MOCK_SORA: ${MOCK_SORA:-false}

      # Other Settings
      ENABLE_METRICS: ${ENABLE_METRICS:-true}
      ENABLE_ENQUEUE_FIRST: ${ENABLE_ENQUEUE_FIRST:-true}
      ENABLE_OUTBOX: ${ENABLE_OUTBOX:-true}
      FORCE_OUTBOX_ONLY: ${FORCE_OUTBOX_ONLY:-true}
      APP_BASE_URL: https://${API_DOMAIN:-api.${DOMAIN}}
      FRONTEND_BASE_URL: https://${DOMAIN}
      VIDEO_PROVIDER: ${VIDEO_PROVIDER:-google}

      # Admin
      ADMIN_EMAIL: ${ADMIN_EMAIL}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
      minio-init:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/healthz"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - cooly-network
      - dokploy-network
    restart: unless-stopped
    labels:
      # Traefik routing for Backend API
      - "traefik.enable=true"
      - "traefik.docker.network=dokploy-network"
      - "traefik.http.routers.backend.rule=Host(`${API_DOMAIN:-api.${DOMAIN}}`)"
      - "traefik.http.routers.backend.entrypoints=websecure"
      - "traefik.http.routers.backend.tls.certresolver=letsencrypt"
      - "traefik.http.services.backend.loadbalancer.server.port=5000"

  # Frontend (Next.js)
  frontend:
    build:
      context: .
      dockerfile: frontend/Dockerfile
      args:
        NEXT_PUBLIC_API_BASE: https://${API_DOMAIN:-api.${DOMAIN}}
        NEXT_PUBLIC_MOCK_API: "false"
        NODE_ENV: production
    container_name: cooly-frontend-prod
    environment:
      NODE_ENV: production
      PORT: 3000
      NEXT_PUBLIC_API_BASE: https://${API_DOMAIN:-api.${DOMAIN}}
      NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: ${NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY}
      NEXT_PUBLIC_POSTHOG_KEY: ${NEXT_PUBLIC_POSTHOG_KEY}
      NEXT_PUBLIC_POSTHOG_HOST: ${NEXT_PUBLIC_POSTHOG_HOST:-https://app.posthog.com}
      NEXT_PUBLIC_SANITY_PROJECT_ID: ${NEXT_PUBLIC_SANITY_PROJECT_ID}
      NEXT_PUBLIC_SANITY_DATASET: ${NEXT_PUBLIC_SANITY_DATASET:-production}
      NEXT_PUBLIC_SANITY_API_VERSION: ${NEXT_PUBLIC_SANITY_API_VERSION:-2025-01-01}
      NEXT_PUBLIC_MOCK_API: ${NEXT_PUBLIC_MOCK_API:-false}
      NEXT_PUBLIC_DEBUG_LOGS: ${NEXT_PUBLIC_DEBUG_LOGS:-false}
      NEXT_PUBLIC_SORA2_HIDE_PRO: ${NEXT_PUBLIC_SORA2_HIDE_PRO:-true}
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - cooly-network
      - dokploy-network
    restart: unless-stopped
    labels:
      # Traefik routing for Frontend
      - "traefik.enable=true"
      - "traefik.docker.network=dokploy-network"
      - "traefik.http.routers.frontend.rule=Host(`${DOMAIN}`) || Host(`www.${DOMAIN}`)"
      - "traefik.http.routers.frontend.entrypoints=websecure"
      - "traefik.http.routers.frontend.tls.certresolver=letsencrypt"
      - "traefik.http.services.frontend.loadbalancer.server.port=3000"
      # Redirect www to non-www
      - "traefik.http.middlewares.redirect-www.redirectregex.regex=^https://www\\.(.+)"
      - "traefik.http.middlewares.redirect-www.redirectregex.replacement=https://$${1}"
      - "traefik.http.middlewares.redirect-www.redirectregex.permanent=true"
      - "traefik.http.routers.frontend.middlewares=redirect-www"

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  minio_data:
    driver: local

networks:
  cooly-network:
    driver: bridge
  dokploy-network:
    external: true
