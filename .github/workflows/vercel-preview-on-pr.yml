name: Vercel preview on PR open

on:
  pull_request:
    types: [opened, reopened, synchronize]

jobs:
  deploy-preview:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          # We push later with our own auth; don't keep the default read-only creds
          persist-credentials: false

      - name: Install Vercel CLI
        run: npm i -g vercel@latest

      - name: Deploy to Vercel Preview
        env:
          VERCEL_ORG_ID:     ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          VERCEL_TOKEN:      ${{ secrets.VERCEL_TOKEN }}
          GITHUB_TOKEN:      ${{ secrets.GITHUB_TOKEN }}
          VERCEL_ENV:        preview
          VERCEL_GIT_PULL_REQUEST_ID: ${{ github.event.pull_request.number }}
        run: |
          # Deploy as preview with PR context
          vercel deploy --yes --token $VERCEL_TOKEN --debug \
            --build-env VERCEL_ENV=preview \
            --build-env VERCEL_GIT_PULL_REQUEST_ID=${{ github.event.pull_request.number }} \
            --env VERCEL_ENV=preview \
            --env VERCEL_GIT_PULL_REQUEST_ID=${{ github.event.pull_request.number }}

      - name: Touch render-trigger so Render redeploys preview
        run: |
          # If the latest commit is already our trigger, skip to avoid loops
          if git log -1 --pretty=%B | grep -q "\[render-trigger\]"; then
            echo "Render trigger already present in last commit. Skipping extra push."
            exit 0
          fi
          echo "$(date -u) trigger" >> .render-trigger
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"
          git add .render-trigger
          git commit -m "[render-trigger] chore(ci): force Render preview redeploy"
          # Authenticated push using GitHub token
          git remote set-url origin https://x-access-token:${{ github.token }}@github.com/${{ github.repository }}
          git push origin HEAD:${{ github.head_ref }}

      - name: Comment PR with Render preview redeploy notice
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const body = `âœ… Render preview redeploy triggered for this PR (API + Worker via render.yaml).\n\n- Vercel preview deployed above.\n- Backend preview (API + Worker) will rebuild automatically on this branch.\n\nTip: ensure render.yaml lists both services and your preview services attach the shared env group.`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });